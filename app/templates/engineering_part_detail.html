{% extends 'base.html' %}
{% block content %}
<div class="page-toolbar maintenance-submenu-row">
  <div class="action-row">
    {% for revision_file_button in revision_file_buttons %}
    <a class="action-btn secondary" href="{{ revision_file_button.href }}" target="_blank" rel="noopener">{{ revision_file_button.label }}</a>
    {% endfor %}
  </div>
  {% if mode == 'edit' %}
  <button type="button" class="small-link-btn toolbar-upload-btn" onclick="document.getElementById('revision-upload-dialog').showModal()">Upload</button>
  {% endif %}
</div>

<form class="part-master-header" method="post" action="/engineering/parts/{{ part.part_id }}/update">
  <div class="part-master-fields">
    <div class="part-master-cell part-id-cell">
      <label>Part ID</label>
      <input value="{{ part.part_id }}" disabled />
    </div>
    <div class="part-master-cell part-desc-cell">
      <label>Description</label>
      <input name="description" value="{{ part.description }}" {% if mode != 'edit' %}disabled{% endif %}/>
    </div>
    <div class="part-master-cell part-rev-cell">
      <label>Revision</label>
      <input type="number" min="0" name="cur_rev" value="{{ part.cur_rev }}" {% if mode != 'edit' %}disabled{% endif %}/>
    </div>
  </div>
  {% if mode == 'edit' %}<button class="header-save-link" type="submit">Save</button>{% endif %}
</form>

<div class="bom-block">
  <h4>Station Routing</h4>
  <form method="post" action="/engineering/parts/{{ part.part_id }}/station-routing" id="station-routing-form" class="panel-form">
    <input type="hidden" name="station_ids" id="station-ids-input" />
    <div class="field-help">Drag stations into the route order for this part. Unassigned stations stay in the available list.</div>
    <div style="display:flex; gap:16px; flex-wrap:wrap;">
      <div>
        <strong>Assigned Route</strong>
        <div id="assigned-stations" class="queue-chip-row" style="min-width:260px; min-height:42px; border:1px dashed #bbb; padding:8px;">
          {% for station in assigned_stations %}
          <div class="queue-chip" draggable="true" data-station-id="{{station.id}}">{{station.station_name}}</div>
          {% endfor %}
        </div>
      </div>
      <div>
        <strong>Available Stations</strong>
        <div id="available-stations" class="queue-chip-row" style="min-width:260px; min-height:42px; border:1px dashed #bbb; padding:8px;">
          {% for station in available_stations %}
          <div class="queue-chip" draggable="true" data-station-id="{{station.id}}">{{station.station_name}}</div>
          {% endfor %}
        </div>
      </div>
    </div>
    {% if mode == 'edit' %}<button type="submit">Save Route</button>{% endif %}
  </form>
</div>


<div class="bom-block">
  <div class="bom-controls">
    <form method="get" action="/engineering/parts/{{ part.part_id }}">
      <input type="hidden" name="mode" value="{{ mode }}" />
      <select name="rev_id" onchange="this.form.submit()">
        {% set revisions = revision_list if revision_list else [selected_rev] %}
        {% for rev in revisions %}
        <option value="{{ rev }}" {% if rev == selected_rev %}selected{% endif %}>Revision {{ rev }}</option>
        {% endfor %}
      </select>
    </form>
    {% if mode == 'edit' %}
    <button type="button" class="small-link-btn" onclick="document.getElementById('add-bom-dialog').showModal()">Add</button>
    {% endif %}
  </div>

  <table>
    <tr><th class="small-col">Line #</th><th>Component</th><th class="small-col">Qty</th></tr>
    {% for line in bom_lines %}
    <tr><td>{{ line.id }}</td><td>{{ line.comp_id }}</td><td>{{ line.comp_qty }}</td></tr>
    {% endfor %}
  </table>
</div>

{% if mode == 'edit' %}
<dialog id="add-bom-dialog" class="modal-dialog">
  <form class="panel-form" method="post" action="/engineering/parts/{{ part.part_id }}/bom-lines">
    <h4>Add Component</h4>
    <input type="hidden" name="rev_id" value="{{ selected_rev }}" />
    <div class="form-field"><label>Component</label><input name="comp_id" required /></div>
    <div class="form-field"><label>Qty</label><input type="number" step="0.001" name="comp_qty" required /></div>
    <div class="action-row">
      <button type="submit">Add</button>
      <button type="button" onclick="document.getElementById('add-bom-dialog').close()">Cancel</button>
    </div>
  </form>
</dialog>
{% endif %}

{% if mode == 'edit' %}
<dialog id="revision-upload-dialog" class="modal-dialog">
  <form class="panel-form revision-upload-form" method="post" enctype="multipart/form-data" action="/engineering/parts/{{ part.part_id }}/revision-header">
    <input type="hidden" name="rev_id" value="{{ selected_rev }}" />
    <table>
      <tr>
        <th></th>
        <th>HK LASER</th>
        <th>OMAX WJ</th>
        <th>BRAKE PRESS</th>
        <th>WELDING</th>
      </tr>
      <tr>
        <td>PDF File</td>
        <td><input type="file" name="hk_pdf_upload" /></td>
        <td><input type="file" name="wj_pdf_upload" /></td>
        <td><input type="file" name="brake_pdf_upload" /></td>
        <td><input type="file" name="weld_pdf_upload" /></td>
      </tr>
      <tr>
        <td>Machine File</td>
        <td><input type="file" name="hk_machine_upload" /></td>
        <td><input type="file" name="wj_machine_upload" /></td>
        <td><input type="file" name="brake_machine_upload" /></td>
        <td><input type="file" name="weld_machine_upload" /></td>
      </tr>
      <tr>
        <td>Qty/DWG</td>
        <td><input type="number" step="0.001" name="hk_qty" value="{{ revision_header.hk_qty if revision_header else 0 }}" /></td>
        <td><input type="number" step="0.001" name="wj_qty" value="{{ revision_header.wj_qty if revision_header else 0 }}" /></td>
        <td><input type="file" name="brake_dwg_upload" /></td>
        <td><input type="file" name="weld_dwg_upload" /></td>
      </tr>
    </table>
    <div class="action-row">
      <button type="submit">Save Uploads</button>
      <button type="button" onclick="document.getElementById('revision-upload-dialog').close()">Cancel</button>
    </div>
  </form>
</dialog>
{% endif %}

<form class="panel-form revision-header-form" method="post" enctype="multipart/form-data" action="/engineering/parts/{{ part.part_id }}/revision-header">
  <input type="hidden" name="rev_id" value="{{ selected_rev }}" />
  <table>
    <tr>
      <th style="width:70%">Released By</th>
      <th style="width:30%">Release Date</th>
    </tr>
    <tr>
      <td><input name="released_by" value="{{ revision_header.released_by if revision_header else '' }}" {% if mode != 'edit' %}disabled{% endif %}/></td>
      <td><input type="date" name="released_date" value="{{ revision_header.released_date.strftime('%Y-%m-%d') if revision_header and revision_header.released_date else '' }}" {% if mode != 'edit' %}disabled{% endif %}/></td>
    </tr>
    <tr>
      <th colspan="2">Release Notes</th>
    </tr>
    <tr>
      <td colspan="2"><textarea class="release-notes-area" name="release_comment" {% if mode != 'edit' %}disabled{% endif %}>{{ revision_header.release_comment if revision_header else '' }}</textarea></td>
    </tr>
  </table>

  {% if mode == 'edit' %}<button type="submit">Save</button>{% endif %}
</form>

<script>
(() => {
  const form = document.getElementById('station-routing-form');
  if (!form) return;
  const assigned = document.getElementById('assigned-stations');
  const available = document.getElementById('available-stations');
  const hidden = document.getElementById('station-ids-input');

  let dragging = null;
  document.querySelectorAll('#assigned-stations .queue-chip, #available-stations .queue-chip').forEach((chip) => {
    chip.addEventListener('dragstart', () => { dragging = chip; });
  });

  const getDropTarget = (container, y) => {
    const chips = [...container.querySelectorAll('.queue-chip:not(.dragging)')];
    return chips.find((chip) => {
      const rect = chip.getBoundingClientRect();
      return y < rect.top + (rect.height / 2);
    }) || null;
  };

  [assigned, available].forEach((container) => {
    container.addEventListener('dragover', (event) => event.preventDefault());
    container.addEventListener('drop', (event) => {
      event.preventDefault();
      if (!dragging) return;
      const dropTarget = getDropTarget(container, event.clientY);
      if (dropTarget) {
        container.insertBefore(dragging, dropTarget);
      } else {
        container.appendChild(dragging);
      }
    });
  });

  form.addEventListener('submit', () => {
    const orderedIds = [...assigned.querySelectorAll('.queue-chip')].map((chip) => chip.dataset.stationId);
    hidden.value = orderedIds.join(',');
  });
})();
</script>

{% endblock %}
