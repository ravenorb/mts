{% extends 'base.html' %}
{% block content %}
<h2>HK CUT FILE DASHBOARD</h2>

<form id="hk-mpf-form">
<table>
  <tr>
    <td><input type="file" name="mpf_file" id="mpf-file" required/></td>
    <td><input type="file" name="pdf_file" id="pdf-file" accept=".pdf" required/></td>
    <td><button type="submit">Upload &amp; Parse</button></td>
    <td><button type="button">Upload &amp; Manual</button></td>
  </tr>
  <tr>
    <th>Primary Part ID</th>
    <th>QTY Produced</th>
    <th>Sheet Size</th>
    <th>Material</th>
  </tr>
  <tr>
    <td><input type="text" id="primary-part-id"/></td>
    <td><input type="number" id="qty-produced" step="1" min="0"/></td>
    <td><input type="text" id="sheet-size"/></td>
    <td><input type="text" id="material"/></td>
  </tr>
</table>
</form>

<p id="hk-parse-status"></p>

<div class="hk-components-header">
  <h3>Components</h3>
  <button type="button" id="add-component-btn" class="action-btn small-link-btn">Add</button>
</div>

<table>
  <tr>
    <th>Sheet QTY</th>
    <th>ASSY QTY</th>
    <th>COMPONENT ID</th>
    <th>ACTION</th>
  </tr>
  <tbody id="components-body"></tbody>
</table>

<h3>Parser Debug JSON</h3>
<pre id="hk-parser-debug" class="debug-json"></pre>

<script>
  const form = document.getElementById('hk-mpf-form');
  const status = document.getElementById('hk-parse-status');
  const componentsBody = document.getElementById('components-body');
  const addComponentBtn = document.getElementById('add-component-btn');
  const parserDebug = document.getElementById('hk-parser-debug');

  const createComponentRow = (component = {}) => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td><input type="number" step="1" min="0" value="${component.sheet_qty ?? ''}"/></td>
      <td><input type="number" step="0.0001" min="0" value="${component.assy_qty ?? ''}"/></td>
      <td><input type="text" value="${component.component_id ?? ''}"/></td>
      <td><button type="button" class="delete-component-btn">Delete</button></td>
    `;

    row.querySelector('.delete-component-btn').addEventListener('click', () => {
      row.remove();
    });

    return row;
  };

  addComponentBtn.addEventListener('click', () => {
    componentsBody.appendChild(createComponentRow());
  });

  form.addEventListener('submit', async (event) => {
    event.preventDefault();
    status.textContent = 'Parsing PDF and MPF files...';

    const data = new FormData(form);
    const response = await fetch('/engineering/hk-mpfs/parse', {
      method: 'POST',
      body: data,
    });

    if (!response.ok) {
      const errorData = await response.json();
      status.textContent = errorData.detail || 'Unable to parse files.';
      return;
    }

    const parsed = await response.json();
    document.getElementById('primary-part-id').value = parsed.primary_part_id || '';
    document.getElementById('qty-produced').value = parsed.qty_produced || 0;
    document.getElementById('sheet-size').value = parsed.sheet_size || '';
    document.getElementById('material').value = parsed.material || '';

    componentsBody.innerHTML = '';
    for (const component of parsed.components || []) {
      componentsBody.appendChild(createComponentRow(component));
    }

    parserDebug.textContent = JSON.stringify(parsed, null, 2);

    status.textContent = 'Parse complete.';
  });
</script>
{% endblock %}
