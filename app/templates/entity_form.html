{% extends 'base.html' %}
{% block content %}
<h2>{% if view_only %}View{% else %}{{ 'Edit' if item else 'New' }}{% endif %} {{entity}}</h2>
{% if not view_only %}<form method="post" action="/entity/{{entity}}/save">{% endif %}
  {% if not view_only and item %}<input type="hidden" name="id" value="{{item.id}}" />{% endif %}
  {% if errors.get('__all__') %}
    <div class="form-error-banner">{{ errors.get('__all__') }}</div>
  {% endif %}
  {% for c in cols %}
    {% set meta = field_meta.get(c.name, {}) %}
    {% set posted = form_values.get(c.name) if form_values else none %}
    {% set current_val = posted if posted is not none else (item|attr(c.name) if item else '') %}
    <div class="form-field">
      <label>{{c.name}}{% if meta.required %} *{% endif %}</label>

      {% if meta.fk_choices %}
        <select name="{{c.name}}" {% if view_only %}disabled{% endif %}>
          <option value="">-- select --</option>
          {% for opt in meta.fk_choices %}
            <option value="{{opt.value}}" {% if current_val|string == opt.value|string %}selected{% endif %}>{{opt.label}}</option>
          {% endfor %}
        </select>
      {% elif meta.choices %}
        <select name="{{c.name}}" {% if view_only %}disabled{% endif %}>
          <option value="">-- select --</option>
          {% for opt in meta.choices %}
            <option value="{{opt}}" {% if current_val|string == opt|string %}selected{% endif %}>{{opt}}</option>
          {% endfor %}
        </select>
      {% else %}
        {% if entity == "employees" and c.name == "password_hash" %}
          <div class="inline-field-row">
            <input name="{{c.name}}" value="{{ current_val }}" readonly disabled/>
            {% if item and not view_only %}<a href="#" id="changePasswordLink">Change</a>{% endif %}
          </div>
        {% else %}
          <input name="{{c.name}}" value="{{ current_val }}" {% if view_only %}disabled{% endif %}/>
        {% endif %}
      {% endif %}

      <div class="field-help">Expected: {{ meta.expected }}</div>
      {% if errors.get(c.name) %}
        <div class="field-error">{{ errors.get(c.name) }}</div>
      {% endif %}
    </div>
  {% endfor %}
  {% if view_only and item %}<a class="action-btn" href="/entity/{{entity}}/{{item.id}}/edit">Edit</a>{% elif not view_only %}<button type="submit">Save</button></form>{% endif %}
  {% if entity == "stations" and item %}
    <div class="action-row">
      <a class="action-btn secondary" href="/entity/consumables">Setup/View Consumables</a>
      <a class="action-btn secondary" href="/entity/station_maintenance_tasks">Setup/View Maintenance Schedule</a>
      <a class="action-btn secondary" href="/entity/maintenance_requests">Review Maintenance Log</a>
      <a class="action-btn secondary" href="/entity/consumable_usage_logs">Review Consumable Log</a>
    </div>
  {% endif %}

{% if entity == "employees" and item and not view_only %}
<div id="passwordModal" class="modal" style="display:none;">
  <div class="modal-content">
    <h3>Change Password</h3>
    <form method="post" action="/entity/employees/{{item.id}}/password">
      <label>New Password</label>
      <input type="password" name="new_password" required minlength="8" />
      <label>Confirm New Password</label>
      <input type="password" name="confirm_password" required minlength="8" />
      <div class="action-row">
        <button type="submit">Save Password</button>
        <button type="button" id="cancelPasswordModal">Cancel</button>
      </div>
    </form>
  </div>
</div>
<script>
  const link = document.getElementById('changePasswordLink');
  const modal = document.getElementById('passwordModal');
  const cancelBtn = document.getElementById('cancelPasswordModal');
  if (link && modal) {
    link.addEventListener('click', (event) => {
      event.preventDefault();
      modal.style.display = 'block';
    });
  }
  if (cancelBtn && modal) {
    cancelBtn.addEventListener('click', () => {
      modal.style.display = 'none';
    });
  }
  window.addEventListener('click', (event) => {
    if (event.target === modal) {
      modal.style.display = 'none';
    }
  });
</script>
{% endif %}
{% endblock %}
