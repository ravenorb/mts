{% extends 'base.html' %}
{% block content %}
<h2>Pallet {{pallet.pallet_code}}</h2>
<div class="cards">
  <div class="card"><div class="label">Status</div><div class="value">{{pallet.status}}</div></div>
  <div class="card"><div class="label">Location / Station</div><div class="value">{{location_label}}</div></div>
  <div class="card"><div class="label">Type</div><div class="value">{{pallet.pallet_type}}</div></div>
</div>

<h3>Parts on Pallet</h3>
<table>
  <tr>
    <th>Component ID</th>
    <th>Qty Needed</th>
    <th>Expected Qty</th>
    <th>Current Qty</th>
    <th>Qty Scrap</th>
    <th>Station ID</th>
    <th>Qty Completed</th>
    <th>Qty Scrap</th>
    <th>Status</th>
  </tr>
  {% for row in part_rows %}
  <tr>
    <td>{{row.component_id or '-'}}</td>
    <td>{{row.qty_needed or 0}}</td>
    <td>{{row.expected_qty or 0}}</td>
    <td>{{row.current_qty or 0}}</td>
    <td>{{row.scrap_qty or 0}}</td>
    <td colspan="4">-</td>
  </tr>
    {% for log in component_station_rollup.get(row.component_id, []) %}
    <tr>
      <td colspan="5"></td>
      <td>{{log.station_id}}</td>
      <td>{{log.qty_completed}}</td>
      <td>{{log.qty_scrap}}</td>
      <td>recorded</td>
    </tr>
    {% endfor %}
  {% endfor %}
</table>

<h3>Station Routing</h3>
<table>
  <tr>
    <th>Pallet ID</th>
    <th>Sequence #</th>
    <th>Station ID</th>
    <th>Qty Completed</th>
    <th>Qty Scrap</th>
    <th>Status</th>
    <th>Location ID</th>
  </tr>
  {% for route in route_rows %}
  <tr>
    <td>{{route.pallet_id}}</td>
    <td>{{route.sequence_no}}</td>
    <td>{{route.station_id or '-'}}</td>
    <td>{{route.qty_completed or 0}}</td>
    <td>{{route.qty_scrap or 0}}</td>
    <td>{{route.status}}</td>
    <td>{{route.location_id}}</td>
  </tr>
  {% endfor %}
</table>

<h3>Timeline</h3>
<ul>
  {% for e in events %}
    <li>{{e.recorded_at}} â€” {{e.event_type}} {% if e.station_id %}(station {{e.station_id}}){% endif %}</li>
  {% endfor %}
</ul>

<h3>Move (Most Common Action)</h3>
<form method="post" action="/production/pallet/{{pallet.id}}/move" class="panel-form">
  <label>Destination type</label>
  <select name="destination_type" required>
    <option value="station">Station</option>
    <option value="storage_bin">Pallet storage bin</option>
  </select>

  <label>Destination</label>
  <select name="destination_id" required>
    <option value="">-- choose destination --</option>
    {% for st in stations %}<option value="{{st.id}}">{{station_label(st)}}</option>{% endfor %}
    {% for b in available_bins %}<option value="{{b.id}}">BIN L{{b.storage_location_id}}-S{{b.shelf_id}}-B{{b.bin_id}}</option>{% endfor %}
  </select>
  <label>Notes (optional)</label>
  <input name="notes" placeholder="e.g. moved from staging rack B" />
  <button class="action-btn" type="submit">MOVE</button>
</form>

<form method="post" action="/production/pallet/{{pallet.id}}/release" style="margin-top:12px;">
  <button class="action-btn" type="submit">RELEASE PALLET</button>
</form>

<div class="action-row">
  <a href="/production/pallet/{{pallet.id}}/edit" class="action-btn">EDIT PALLET</a>
  <a href="/entity/pallets" class="action-btn secondary">SPLIT / MERGE</a>
  <a href="/entity/pallet_events" class="action-btn secondary">SCRAP / HOLD / COMPLETE</a>
  <a href="/entity/pallet_revisions" class="action-btn secondary">VIEW DRAWINGS</a>
</div>
{% endblock %}
