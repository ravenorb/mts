{% extends 'base.html' %}
{% block content %}
<h2>Complete Pallet {{pallet.pallet_code}} @ {{station.station_name}}</h2>

<form method="post" action="/stations/{{station.id}}/complete" class="panel-form">
  <table>
    <tr>
      <th>Component ID</th>
      <th>Qty Expected</th>
      <th>Qty Completed</th>
      <th>Qty Scrap</th>
    </tr>
    {% for row in part_rows %}
    <tr>
      <td>
        {{row.component_id}}
        <input type="hidden" name="component_id" value="{{row.component_id}}" />
      </td>
      <td>
        {{row.expected_qty or 0}}
        <input type="hidden" name="qty_expected" value="{{row.expected_qty or 0}}" />
      </td>
      <td><input type="number" step="0.01" name="qty_completed" value="{{row.expected_qty or 0}}" required /></td>
      <td><input type="number" step="0.01" name="qty_scrap" value="0" required /></td>
    </tr>
    {% endfor %}
  </table>

  <label>If completed less than expected, spawn leftover pallet?</label>
  <select name="spawn_leftover">
    <option value="no">No</option>
    <option value="yes">Yes</option>
  </select>

  <label>After completion</label>
  <select name="route_choice" id="route-choice">
    <option value="queue_next">Queue to next station</option>
    <option value="store">Store pallet</option>
  </select>

  <div id="storage-picker" style="display:none;">
    <label>Storage bin</label>
    <select name="storage_bin_id">
      <option value="">-- choose pallet storage bin --</option>
      {% for b in available_bins %}
      <option value="{{b.id}}">L{{b.storage_location_id}}-S{{b.shelf_id}}-B{{b.bin_id}}</option>
      {% endfor %}
    </select>
  </div>

  <div class="action-row">
    <button type="submit">Complete Pallet</button>
    <a class="action-btn secondary" href="/stations/{{station.id}}">Cancel</a>
  </div>
</form>

<script>
(() => {
  const routeChoice = document.getElementById('route-choice');
  const storagePicker = document.getElementById('storage-picker');
  const updateVisibility = () => {
    storagePicker.style.display = routeChoice.value === 'store' ? 'block' : 'none';
  };
  routeChoice?.addEventListener('change', updateVisibility);
  updateVisibility();
})();
</script>
{% endblock %}
