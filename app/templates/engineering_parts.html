{% extends 'base.html' %}
{% block content %}
<div class="page-toolbar">
  <div class="section-nav" aria-label="Parts actions">
    <a class="active" href="/engineering/parts">Parts</a>
  </div>
  <div class="action-row" style="margin-top:0; margin-left:auto;">
  <form id="parts-pdf-upload-form" method="post" enctype="multipart/form-data" action="/engineering/parts/upload-pdf" style="display:none;">
    <input type="file" id="parts-pdf-file" name="pdf_file" accept=".pdf,application/pdf" />
    <input type="file" id="parts-hk-machine-file" name="hk_machine_file" />
  </form>
  <button type="button" id="parts-upload-pdf-btn" class="action-btn">Upload PDF</button>
  <button type="button" id="parts-select-mpf-btn" class="action-btn" style="display:none;">Select MPF File</button>
  <a class="action-btn {% if show_add %}active-tab{% endif %}" href="/engineering/parts?mode=add">Add</a>
  </div>
</div>
<p id="parts-upload-status" style="margin-top:0.5rem;"></p>

{% if show_add %}
<form class="panel-form" method="post" action="/engineering/parts">
  <div class="form-field"><label>Part ID</label><input name="part_id" required /></div>
  <div class="form-field"><label>Description</label><input name="description" /></div>
  <button type="submit">Save Part</button>
</form>
{% endif %}

<table>
  <tr>
    <th>Part ID</th>
    <th>Description</th>
    <th>Current Rev</th>
    <th>Actions</th>
  </tr>
  {% for part in parts %}
  <tr>
    <td>{{ part.part_id }}</td>
    <td>{{ part.description }}</td>
    <td>{{ part.cur_rev }}</td>
    <td class="actions-links">
      <a href="/engineering/parts/{{ part.part_id }}?mode=edit">edit</a>
      |
      <form method="post" action="/engineering/parts/{{ part.part_id }}/delete" style="display:inline;" onsubmit="return confirm('Delete part {{ part.part_id }}?');">
        <button type="submit" class="danger-link-btn">delete</button>
      </form>
    </td>
  </tr>
  {% endfor %}
</table>

{% set page_count = ((total_parts + page_size - 1) // page_size) %}
{% if page_count > 1 %}
<div class="action-row">
  {% for p in range(1, page_count + 1) %}
    <a class="action-btn {% if p == page %}active-tab{% endif %}" href="/engineering/parts?page={{ p }}{% if show_add %}&mode=add{% endif %}">{{ p }}</a>
  {% endfor %}
</div>
{% endif %}

<script>
  const uploadPdfBtn = document.getElementById('parts-upload-pdf-btn');
  const uploadPdfInput = document.getElementById('parts-pdf-file');
  const uploadMachineInput = document.getElementById('parts-hk-machine-file');
  const uploadPdfForm = document.getElementById('parts-pdf-upload-form');
  const selectMpfBtn = document.getElementById('parts-select-mpf-btn');
  const uploadStatus = document.getElementById('parts-upload-status');

  const openMachineFilePicker = () => {
    if (typeof uploadMachineInput.showPicker === 'function') {
      uploadMachineInput.showPicker();
      return;
    }
    uploadMachineInput.click();
  };

  uploadPdfBtn.addEventListener('click', () => {
    uploadPdfInput.click();
  });

  uploadPdfInput.addEventListener('change', () => {
    if (!uploadPdfInput.files || uploadPdfInput.files.length === 0) {
      return;
    }

    uploadMachineInput.value = '';
    const shouldUploadMachineFile = window.confirm(
      'Do you want to upload the corresponding HK laser MPF file?'
    );

    if (!shouldUploadMachineFile) {
      selectMpfBtn.style.display = 'none';
      uploadStatus.textContent = '';
      uploadPdfForm.submit();
      return;
    }

    uploadStatus.textContent = 'Select the MPF file to continue upload.';
    selectMpfBtn.style.display = 'inline-flex';
    openMachineFilePicker();
  });

  selectMpfBtn.addEventListener('click', () => {
    openMachineFilePicker();
  });

  uploadMachineInput.addEventListener('change', () => {
    if (!uploadPdfInput.files || uploadPdfInput.files.length === 0) {
      return;
    }
    if (!uploadMachineInput.files || uploadMachineInput.files.length === 0) {
      return;
    }

    selectMpfBtn.style.display = 'none';
    uploadStatus.textContent = '';

    uploadPdfForm.submit();
  });
</script>
{% endblock %}
