{% extends 'base.html' %}
{% block content %}
<div class="page-toolbar">
  <h2>Production</h2>
  <button id="open-order-modal" type="button">Create Order</button>
</div>

<form method="get" action="/production" class="scan-form">
  <input type="hidden" name="tab" value="{{tab}}" />
  <label>Scan QR OR type pallet</label>
  <input name="q" value="{{query}}" placeholder="P-10452 or pallet id" autofocus />
  <button type="submit">Find</button>
</form>

<div class="action-row" style="margin:12px 0;">
  <a class="action-btn {% if tab == 'active' %}secondary{% endif %}" href="/production?tab=active">Active Pallets</a>
  {% for station in stations %}
  <a class="action-btn {% if tab == ('station-' ~ station.id) %}secondary{% endif %}" href="/production?tab=station-{{station.id}}">{{station.station_name}}</a>
  {% endfor %}
</div>

{% if found %}
<div class="card">
  <div class="label">Pallet found</div>
  <a href="/production/pallet/{{found.id}}" class="action-btn">Open {{found.pallet_code}}</a>
</div>
{% elif query %}
<div class="form-error-banner">No pallet found for "{{query}}". Check scan quality or code format.</div>
{% endif %}

{% if tab == 'active' %}
<h3>All Active Pallets</h3>
<table>
  <tr>
    <th>Pallet</th><th>Status</th><th>Frame Part</th><th>Expected Qty</th><th>Station</th><th>Actions</th>
  </tr>
  {% for pallet in active_pallets %}
  <tr>
    <td>{{pallet.pallet_code}}</td>
    <td>{{pallet.status}}</td>
    <td>{{pallet.frame_part_number or '-'}}</td>
    <td>{{pallet.expected_quantity or '-'}}</td>
    <td>{{pallet.current_station_id or '-'}}</td>
    <td>
      <a class="small-link-btn" href="/production/pallet/{{pallet.id}}">Open</a>
      <a class="small-link-btn" href="/production/pallet/{{pallet.id}}/edit">Edit Pallet</a>
    </td>
  </tr>
  {% endfor %}
</table>
{% elif selected_station %}
<h3>{{selected_station.station_name}} Queue</h3>
<table>
  <tr>
    <th>Queue Pos</th><th>Pallet</th><th>Status</th><th>Frame Part</th><th>Expected Qty</th><th>Actions</th>
  </tr>
  {% for row in station_queue %}
  <tr>
    <td>{{row.queue.queue_position}}</td>
    <td>{{row.pallet.pallet_code if row.pallet else '-'}}</td>
    <td>{{row.queue.status}}</td>
    <td>{{row.pallet.frame_part_number if row.pallet else '-'}}</td>
    <td>{{row.pallet.expected_quantity if row.pallet else '-'}}</td>
    <td>{% if row.pallet %}<a class="small-link-btn" href="/production/pallet/{{row.pallet.id}}">Open</a>{% endif %}</td>
  </tr>
  {% endfor %}
</table>
{% endif %}

<dialog id="create-order-modal" class="modal-dialog">
  <form method="post" action="/production/create-order" class="panel-form" id="create-order-form">
    <h3>Create Production Order</h3>
    <label>Frame part ID</label>
    <select name="frame_part_id" id="frame-part-id" required>
      <option value="">-- select frame part --</option>
      {% for part_id in frame_parts %}
        <option value="{{part_id}}">{{part_id}}</option>
      {% endfor %}
    </select>

    <label>HK MPF file</label>
    <select name="mpf_master_id" id="mpf-master-id" required>
      <option value="">-- select frame part first --</option>
    </select>

    <label>Expected quantity</label>
    <select name="expected_quantity" id="expected-quantity" required>
      <option value="">-- select HK MPF first --</option>
    </select>
    <div class="field-help" id="mpf-help">Quantities are generated as multiples of qty produced.</div>

    <div class="action-row">
      <button type="submit">Create pallet + order</button>
      <button type="button" id="cancel-order-modal">Cancel</button>
    </div>
  </form>
</dialog>

<script>
(() => {
  const modal = document.getElementById('create-order-modal');
  const openBtn = document.getElementById('open-order-modal');
  const cancelBtn = document.getElementById('cancel-order-modal');
  const framePartSelect = document.getElementById('frame-part-id');
  const mpfSelect = document.getElementById('mpf-master-id');
  const expectedQtySelect = document.getElementById('expected-quantity');
  const mpfHelp = document.getElementById('mpf-help');

  openBtn?.addEventListener('click', () => modal?.showModal());
  cancelBtn?.addEventListener('click', () => modal?.close());

  let currentMpfOptions = [];
  framePartSelect?.addEventListener('change', async () => {
    const framePart = framePartSelect.value;
    mpfSelect.innerHTML = '<option value="">-- loading --</option>';
    expectedQtySelect.innerHTML = '<option value="">-- select HK MPF first --</option>';
    currentMpfOptions = [];
    if (!framePart) {
      mpfSelect.innerHTML = '<option value="">-- select frame part first --</option>';
      return;
    }
    const response = await fetch(`/production/mpf-options/${encodeURIComponent(framePart)}`);
    const payload = await response.json();
    currentMpfOptions = payload.items || [];
    if (!currentMpfOptions.length) {
      mpfSelect.innerHTML = '<option value="">-- no HK MPF files found --</option>';
      return;
    }
    mpfSelect.innerHTML = '<option value="">-- select HK MPF --</option>' + currentMpfOptions.map((item) => (
      `<option value="${item.id}">${item.filename} | qty produced ${item.qty_produced} | ${item.material || 'n/a'} ${item.sheet_size || ''}</option>`
    )).join('');
  });

  mpfSelect?.addEventListener('change', () => {
    const selected = currentMpfOptions.find((item) => String(item.id) === mpfSelect.value);
    expectedQtySelect.innerHTML = '<option value="">-- select expected quantity --</option>';
    if (!selected || !selected.qty_produced || selected.qty_produced <= 0) {
      mpfHelp.textContent = 'Selected HK MPF has no qty produced value.';
      return;
    }
    const step = Number(selected.qty_produced);
    const options = [];
    for (let multiplier = 1; multiplier <= 25; multiplier += 1) {
      const qty = (step * multiplier).toFixed(2);
      options.push(`<option value="${qty}">${qty} (${multiplier} sheet${multiplier > 1 ? 's' : ''})</option>`);
    }
    expectedQtySelect.innerHTML += options.join('');
    mpfHelp.textContent = `Qty produced per sheet: ${step}. Choose desired multiple.`;
  });
})();
</script>
{% endblock %}
